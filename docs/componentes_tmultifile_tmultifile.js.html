<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>componentes/tmultifile/tmultifile.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Global.html">Global</a><ul class='methods'><li data-type='method'><a href="module-Global.html#~__adianti_ajax_exec">__adianti_ajax_exec</a></li><li data-type='method'><a href="module-Global.html#~__adianti_ajax_lookup">__adianti_ajax_lookup</a></li><li data-type='method'><a href="module-Global.html#~__adianti_append_page">__adianti_append_page</a></li><li data-type='method'><a href="module-Global.html#~__adianti_base_url">__adianti_base_url</a></li><li data-type='method'><a href="module-Global.html#~__adianti_block_ui">__adianti_block_ui</a></li><li data-type='method'><a href="module-Global.html#~__adianti_can_open_iframe">__adianti_can_open_iframe</a></li><li data-type='method'><a href="module-Global.html#~__adianti_clear_tabs">__adianti_clear_tabs</a></li><li data-type='method'><a href="module-Global.html#~__adianti_create_tab_item">__adianti_create_tab_item</a></li><li data-type='method'><a href="module-Global.html#~__adianti_debounce">__adianti_debounce</a></li><li data-type='method'><a href="module-Global.html#~__adianti_dialog">__adianti_dialog</a></li><li data-type='method'><a href="module-Global.html#~__adianti_download_file">__adianti_download_file</a></li><li data-type='method'><a href="module-Global.html#~__adianti_error">__adianti_error</a></li><li data-type='method'><a href="module-Global.html#~__adianti_failure_request">__adianti_failure_request</a></li><li data-type='method'><a href="module-Global.html#~__adianti_get_page">__adianti_get_page</a></li><li data-type='method'><a href="module-Global.html#~__adianti_goto_page">__adianti_goto_page</a></li><li data-type='method'><a href="module-Global.html#~__adianti_init_tabs">__adianti_init_tabs</a></li><li data-type='method'><a href="module-Global.html#~__adianti_input">__adianti_input</a></li><li data-type='method'><a href="module-Global.html#~__adianti_load_html">__adianti_load_html</a></li><li data-type='method'><a href="module-Global.html#~__adianti_load_page">__adianti_load_page</a></li><li data-type='method'><a href="module-Global.html#~__adianti_load_tab">__adianti_load_tab</a></li><li data-type='method'><a href="module-Global.html#~__adianti_message">__adianti_message</a></li><li data-type='method'><a href="module-Global.html#~__adianti_open_page">__adianti_open_page</a></li><li data-type='method'><a href="module-Global.html#~__adianti_parse_html">__adianti_parse_html</a></li><li data-type='method'><a href="module-Global.html#~__adianti_post_data">__adianti_post_data</a></li><li data-type='method'><a href="module-Global.html#~__adianti_process_popover">__adianti_process_popover</a></li><li data-type='method'><a href="module-Global.html#~__adianti_query_string">__adianti_query_string</a></li><li data-type='method'><a href="module-Global.html#~__adianti_query_to_json">__adianti_query_to_json</a></li><li data-type='method'><a href="module-Global.html#~__adianti_question">__adianti_question</a></li><li data-type='method'><a href="module-Global.html#~__adianti_register_state">__adianti_register_state</a></li><li data-type='method'><a href="module-Global.html#~__adianti_scroll_tab">__adianti_scroll_tab</a></li><li data-type='method'><a href="module-Global.html#~__adianti_scroll_to_active_tab">__adianti_scroll_to_active_tab</a></li><li data-type='method'><a href="module-Global.html#~__adianti_set_active_iframe">__adianti_set_active_iframe</a></li><li data-type='method'><a href="module-Global.html#~__adianti_set_current_tab">__adianti_set_current_tab</a></li><li data-type='method'><a href="module-Global.html#~__adianti_set_debug">__adianti_set_debug</a></li><li data-type='method'><a href="module-Global.html#~__adianti_set_language">__adianti_set_language</a></li><li data-type='method'><a href="module-Global.html#~__adianti_set_name">__adianti_set_name</a></li><li data-type='method'><a href="module-Global.html#~__adianti_show_popover">__adianti_show_popover</a></li><li data-type='method'><a href="module-Global.html#~__adianti_store_tab_content">__adianti_store_tab_content</a></li><li data-type='method'><a href="module-Global.html#~__adianti_unblock_ui">__adianti_unblock_ui</a></li><li data-type='method'><a href="module-Global.html#~__adianti_warning">__adianti_warning</a></li><li data-type='method'><a href="module-Global.html#~__adianti_window">__adianti_window</a></li></ul></li><li><a href="module-TArrowStep.html">TArrowStep</a><ul class='methods'><li data-type='method'><a href="module-TArrowStep.html#~tarrowstep_disable_field">tarrowstep_disable_field</a></li><li data-type='method'><a href="module-TArrowStep.html#~tarrowstep_enable_field">tarrowstep_enable_field</a></li></ul></li><li><a href="module-TBarcodeInputReader.html">TBarcodeInputReader</a></li><li></li><li><a href="module-TButton.html">TButton</a></li><li><a href="module-TCheckGroup.html">TCheckGroup</a></li><li><a href="module-TColor.html">TColor</a></li><li><a href="module-TCombo.html">TCombo</a></li><li><a href="module-TDataGrid.html">TDataGrid</a></li><li><a href="module-TDate.html">TDate</a></li><li><a href="module-TDateTime.html">TDateTime</a></li><li><a href="module-TDbEntry.html">TDbEntry</a></li><li><a href="module-TDbMultiSearch.html">TDbMultiSearch</a></li><li><a href="module-TDbUniqueSearch.html">TDbUniqueSearch</a></li><li><a href="module-TDialog.html">TDialog</a></li><li><a href="module-TEntry.html">TEntry</a><ul class='methods'><li data-type='method'><a href="module-TEntry.html#~tentry_lower">tentry_lower</a></li><li data-type='method'><a href="module-TEntry.html#~tentry_mask">tentry_mask</a></li><li data-type='method'><a href="module-TEntry.html#~tentry_upper">tentry_upper</a></li></ul></li><li><a href="module-TExpander.html">TExpander</a></li><li><a href="module-TField.html">TField</a></li><li><a href="module-TFieldList.html">TFieldList</a></li><li><a href="module-TFile.html">TFile</a></li><li><a href="module-TForm.html">TForm</a></li><li><a href="module-TFullCalendar.html">TFullCalendar</a></li><li><a href="module-THtmlEditor.html">THtmlEditor</a></li><li><a href="module-TIcon.html">TIcon</a></li><li><a href="module-TImageCropper.html">TImageCropper</a></li><li><a href="module-TJQueryDialog.html">TJQueryDialog</a></li><li><a href="module-TKanban.html">TKanban</a></li><li><a href="module-TLabel.html">TLabel</a></li><li><a href="module-TMenuBar.html">TMenuBar</a></li><li><a href="module-TMultiEntry.html">TMultiEntry</a></li><li><a href="module-TMultiFile.html">TMultiFile</a><ul class='methods'><li data-type='method'><a href="module-TMultiFile.html#~MultiFileUploader">MultiFileUploader</a></li></ul></li><li></li><li><a href="module-TPassword.html">TPassword</a></li><li><a href="module-TQrCodeInputReader.html">TQrCodeInputReader</a></li><li><a href="module-TRadioGroup.html">TRadioGroup</a></li><li><a href="module-TSeekButton.html">TSeekButton</a></li><li><a href="module-TSelect.html">TSelect</a></li><li><a href="module-TSlider.html">TSlider</a></li><li><a href="module-TSortList.html">TSortList</a></li><li><a href="module-TSpinner.html">TSpinner</a></li><li><a href="module-TTable.html">TTable</a></li><li><a href="module-TTreeView.html">TTreeView</a></li><li><a href="module-TiconView.html">TiconView</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">componentes/tmultifile/tmultifile.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @module TMultiFile */

/**
 * Hidden's nao podem ser criados sempre na createStatusRow(), pois na edição vem pronto do TMultiFile.php
 * Resolvido pois ele dá um remove do hidden criado pelo php, logo após dar um start
 */
function MultiFileUploader(input_id, obj_file, service_action, parent_container, complete_action, file_handling, image_gallery, popover)
{
    this.field_name = $('#' + input_id).attr('receiver');
    this.obj_file = obj_file;
    this.service_action = service_action;
    this.complete_action   = complete_action;
    this.file_handling     = file_handling;
    this.image_gallery     = JSON.parse( image_gallery );
    this.popover           = JSON.parse( popover );
    this.parent_container  = $('#'+parent_container);
    this.instances = [];
    var that = this;
    
    // Create structure of status row
    this.createStatusRow = function()
    {
        var input_file = that.parent_container.find('[widget=tmultifile]')[0];
        var input_size = $(input_file).css('width');
        var file_row_wrapper  = $('&lt;div />',  {'class': 'tfile_row_wrapper tfile_row_wrapper-'+input_id});
        var file_row_1        = $('&lt;div />',  {'class': 'tfile_row_1'});
        var file_row_2        = $('&lt;div />',  {'class': 'tfile_row_2'});
        var file_link_wrapper = $('&lt;div />',  {'class': 'tfile_link_wrapper', 'style': 'width: calc('+ input_size +' - 25px)'});
        var file_del_icon     = $('&lt;span />', {'class': 'tfile_del_icon fa fa-minus-circle gray', 'title': 'Remover'});
        var file_progress_bar = $('&lt;div />',  {'class': 'progress-bar progress-bar-success', 'style': 'width: 0%; height: 2px;'});
        var file_input_hidden = $('&lt;input />',{type: 'hidden', name: that.field_name+'[]'});
        
        if (that.image_gallery.enabled == '1')
        {
            $(file_link_wrapper).css('width','unset');
            $(file_row_wrapper).css('border','1px solid gray');
            $(file_row_wrapper).css('border-radius','3px');
            $(file_row_wrapper).css('margin','2px');
            $(file_row_wrapper).css('display','inline-block');
        }
        
        that.file_row_wrapper  = file_row_wrapper;
        that.file_input_hidden = file_input_hidden;
        that.file_progress_bar = file_progress_bar;
        that.file_link_wrapper = file_link_wrapper;
        
        //that.parent_container.children('.tfile_row_wrapper').remove();
        that.parent_container.append(file_row_wrapper);
        file_row_wrapper.append(file_row_1);
        file_row_wrapper.append(file_row_2);
        file_row_1.append(file_input_hidden, file_link_wrapper, file_del_icon);
        file_row_2.append(file_progress_bar);
        
        $(file_del_icon).click(
            function(){
                var file_data = that.getData();
                
                file_row_wrapper.hide();
                that.parent_container.children('i').attr({'class' : '', 'title' : ''});
                that.parent_container.find('[widget=tmultifile]').css('padding-left', '5px');
                
                // check the file to be deleted
                file_data.delFile = file_data.fileName;
                
                // if delete recently included file (not in server already)
                if (file_data.delFile == file_data.newFile) {
                    file_data = '';
                    that.setData(file_data);
                    file_row_wrapper.remove();
                }
                
                that.setData(file_data);
            }
        );
        
        return file_row_wrapper;
    }

    this.createInputHidden = function(value)
    {
        var file_input_hidden = $('&lt;input />',{
            type: 'hidden',
            name: that.field_name+'[]',
            widget: "thidden",
            value: value
        });

        that.parent_container.append(file_input_hidden);
        
        return file_input_hidden;
    };
    
    // Show file
    this.showFile = function(file_data)
    {
        if (typeof file_data == 'undefined')
        {
            var file_data  = this.getData();
        }
        var file_name = file_data.fileName;
        
        if (file_name) {
            var file_row_wrapper  = that.file_row_wrapper;
            var file_link_wrapper = file_row_wrapper.find('.tfile_link_wrapper');
            file_row_wrapper.find('.progress-bar').css('width', '100%');
            
            if ($.inArray( file_name.split('.').pop().toLowerCase(), [ "png", "jpg", "jpeg", "gif", "svg", "webp", "ico", "fav" ] ) > -1) {
                var pop_template = '&lt;div class="popover" role="tooltip" style="z-index:100000;max-width:800px">&lt;div class="arrow">&lt;/div>&lt;h3 class="popover-title popover-header">&lt;/h3>&lt;div class="popover-content popover-body">&lt;div class="data-content">&lt;/div>&lt;/div>&lt;/div>';
                var pop_content  = '&lt;img style="max-width:460px" src="download.php?file={file_name}">';
                
                if (that.popover.content) {
                    pop_content = atob(that.popover.content);
                }
                
                pop_content = pop_content.replace('{file_name}', file_name);
                if (that.image_gallery.enabled == '1')
                {
                    var file_link = $('&lt;a />', { 'href': 'download.php?file='+file_name, 'target' : '_blank' });
                    var image = $('&lt;img />', { 'src': 'download.php?file='+file_name }).height(that.image_gallery.height).width(that.image_gallery.width);
                    file_link.append(image);
                    
                    if (that.popover.enabled == '1') {
                        file_link_wrapper.popover({
                            trigger: "hover",
                            'content': pop_content,
                            'html' : true,
                            'container': 'body',
                            'template': pop_template,
                            title: that.popover.title || ""
                        });
                    }
                }
                else
                {
                    var file_link = $('&lt;a />', { 'href': 'download.php?file='+file_name, 'target' : '_blank'});
                    
                    if (that.popover.enabled == '1') {
                        file_link.popover({
                            trigger: "hover",
                            'content': pop_content,
                            'html' : true,
                            'container': 'body',
                            'template': pop_template,
                            title: that.popover.title || ""
                        });
                    }
                }
            }
            else {
                var file_link = $('&lt;a />', { 'href': 'download.php?file='+file_name, 'target' : '_blank' });
            }
            
            if (that.image_gallery.enabled != '1')
            {
                file_link.append(file_name);
            }
            file_link_wrapper.html(file_link);
       }
    };
    
    // Get file data
    this.getData = function()
    {
        var file_data = decodeURIComponent(that.file_input_hidden.val());
        var file_data_json = '';
        
        try {
            file_data_json = file_data ? JSON.parse(file_data) : {};
        }
        catch(e) {
            file_data_json = {};
        }
        return file_data_json;
    };
    
    // Set file data
    this.setData = function(data)
    {
        if (data) {
            $(that.file_input_hidden).val(encodeURIComponent(JSON.stringify(data)));
        }
        else {
            $(that.file_input_hidden).val('');
        }
    };
    
    // Ajax uploads are supported
    this.supportAjaxUploadWithProgress = function()
    {
        return this.supportFileAPI() &amp;&amp; this.supportAjaxUploadProgressEvents() &amp;&amp; this.supportFormData();
    };
    
    // File API supported?
    this.supportFileAPI = function()
    {
        var fi = document.createElement('INPUT');
        fi.type = 'file';
        return 'files' in fi;
    };
        
    // Progress events supported?
    this.supportAjaxUploadProgressEvents = function()
    {
        var xhr = new XMLHttpRequest();
        return !! (xhr &amp;&amp; ('upload' in xhr) &amp;&amp; ('onprogress' in xhr.upload));
    };
    
    // FormData supported
    this.supportFormData = function()
    {
        return !! window.FormData;
    };
    
    // Start upload
    this.initFileUpload = function()
    {
        //if (that.file_handling) {
            this.createStatusRow();
        //}
        
        if (this.supportAjaxUploadWithProgress()) {
            var form_data = new FormData();
            var file = that.obj_file;
            form_data.append('fileName', file);
            this.sendXHRequest(form_data, that.service_action);
        }
    };
    
    // Send request
    this.sendXHRequest = function(form_data, uri)
    {
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener('loadstart', this.onLoadStart, false);
        xhr.upload.addEventListener('progress', this.onProgress, false);
        xhr.upload.addEventListener('load', this.onLoad, false);
        xhr.addEventListener('readystatechange', this.onReadyStateChange, false);
        xhr.open('POST', uri, true);
        xhr.send(form_data);
    };
    
    // Handle the start of the upload
    this.onLoadStart = function(evt)
    {
        if( that.parent_container.children('i').length == 0 ) {
            that.parent_container.prepend($('&lt;i>'));
        }
        that.parent_container.find('[widget=tmultifile]').css('padding-left', '20px');
        that.parent_container.children('i').attr({'class'   : 'fa fa-spinner fa-spin fa-fw blue file-response-icon',
                                                  'title' : '...'});
    };
    
    // Handle the end of the upload
    this.onLoad = function(evt)
    {
    };
    
    // Handle the progress
    this.onProgress = function(evt)
    {
        if( evt.lengthComputable ) {
            var percent = Math.round(evt.loaded * 100 / evt.total);
            that.file_progress_bar.css('width',percent+'%').css('height', 2);
            that.file_link_wrapper.html(percent + '%');
        }
    };
    
    // Handle the response from the server
    this.onReadyStateChange = function(evt)
    {
        var status = null;
        
        try {
            status = evt.target.status;
        }
        catch(e) {
            return;
        }
        
        if (status == '200' &amp;&amp; evt.target.readyState == '4' &amp;&amp; evt.target.responseText) {
            try {
                var response = JSON.parse( evt.target.responseText );
                
                if ( response.type == 'success' ) {
                    if (that.file_handling) {
                        var file_data      = that.getData();
                        file_data.newFile  = 'tmp/' + response.fileName;
                        file_data.fileName = 'tmp/' + response.fileName;
                        
                        that.setData(file_data);
                        that.showFile(file_data);
                    }
                    else {
                        that.file_input_hidden.val(response.fileName);
                        that.file_link_wrapper.html(response.fileName);
                    }
                    
                    that.showMessage('success', 'Sucesso');
                    if (this.readyState == 4 &amp;&amp; typeof(that.complete_action) == "function") {
                        that.complete_action();
                    }
                }
                else {
                    that.file_row_wrapper.remove();
                    that.showMessage('error', response.msg);
                }
            }
            catch (e)
            {
                that.file_row_wrapper.remove();
                
                if (typeof response == "undefined") {
                    that.showMessage('error', evt.target.responseText);
                }
                else {
                    that.showMessage('error', e);
                }
            }
        }
    };
    
    // Show message
    this.showMessage = function(type, message)
    {
        if (type == 'success') {
            that.parent_container.find('[widget=tmultifile]').css('padding-left', '20px');
            that.parent_container.children('i').attr({ 'class' : 'far fa-check-circle green file-response-icon',
                                                       'title' : message });
        }
        else if (type == 'error') {
            that.parent_container.find('[widget=tmultifile]').css('padding-left', '20px');
            that.parent_container.children('i').attr({ 'class' : 'fa fa-exclamation-circle red file-response-icon',
                                                       'title' : message });
        }
    };
    
    this.clear = function()
    {
        $('.tfile_row_wrapper-'+input_id).each(function(){
            $(this).find('input').each(function(){
                $(this).val('');
            });
            
            $(this).remove();
        });
        
        that.parent_container.children('i').attr({'class' : '', 'title' : ''});
        that.parent_container.find('[widget=tmultifile]').css('padding-left', '5px');
        
        $('[name="file_'+this.field_name+'[]"]').val('');
        $(this.file_input_hidden).val('');
        $('#'+this.input_id).val('');
    }
    
    this.setValue = function(values)
    {
        this.clear();
        
        if(!values) 
        {
            return;
        }
        
        try {
            values = JSON.parse(values);
        } catch (e) {
            
        }
        
        for (var index in values) 
        {
            
            var value = values[index];
            var data = {"idFile" : index, "fileName": value};
            
            
            
            if(value.indexOf('%7B%') >= 0 )
            {
                data = JSON.parse(decodeURIComponent(value));
            }
            
            if(this.file_handling) 
            {
                this.createStatusRow();
                this.setData(data);
                this.showFile();
            } 
            else 
            {
                this.createInputHidden(value);
            }
        }
    }
    
    this.addInstance = function(instance)
    {
        this.instances.push(instance);
    }
}

function tmultifile_start( input_id, parent_container, service_action, complete_action, file_handling, image_gallery, popover )
{
    var masterFile = new  MultiFileUploader(input_id, null, service_action, parent_container, complete_action, file_handling, image_gallery, popover);

    $(function() {
        $('#' + input_id).change( function() {
            // iterate selected files in upload dialog
            $.each( $(this).prop('files'), function(index, upload_file) {
                var file = new  MultiFileUploader(input_id, upload_file, service_action, parent_container, complete_action, file_handling, image_gallery, popover);                    
                file.initFileUpload();
                masterFile.addInstance(file);
            });
        });
        
        if (file_handling) {
            $('#'+input_id).parent().children('input[type=hidden]').each(function(index, input_hidden) {
                var file = new  MultiFileUploader(input_id, null, service_action, parent_container, complete_action, file_handling, image_gallery, popover);
                file.createStatusRow();
                if ($(input_hidden).val())
                {
                    file.setData( JSON.parse(decodeURIComponent($(input_hidden).val())) );
                }
                file.showFile();
                $(input_hidden).remove();
                masterFile.addInstance(file);
            });
        }
        
        $('#' + input_id)[0].tmultifile = masterFile;

    });
}


function tmultifile_enable_field(form_name, field) {
    try {
        $('form[name='+form_name+'] [name=\'file_'+field+'[]\']').removeAttr('disabled');
        $('form[name='+form_name+'] [name=\'file_'+field+'[]\']').removeClass('tfield_disabled').addClass('tfield');
    } catch (e) {
        console.log(e);
    }
}

function tmultifile_disable_field(form_name, field) {
    try {
        $('form[name='+form_name+'] [name=\'file_'+field+'[]\']').attr('disabled', true);
        $('form[name='+form_name+'] [name=\'file_'+field+'[]\']').removeClass('tfield').addClass('tfield_disabled');
    } catch (e) {
        console.log(e);
    }
}

function tmultifile_clear_field(form_name, field) {
    try {
        $('form[name='+form_name+'] [name=\''+field+'[]\']').val('');
        $('form[name='+form_name+'] [name=\'file_'+field+'[]\']').val('');
    } catch (e) {
        console.log(e);
    }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Mon Aug 21 2023 12:34:09 GMT-0300 (Horário Padrão de Brasília) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
